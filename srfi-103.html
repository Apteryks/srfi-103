<!DOCTYPE html PUBLIC
    "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>SRFI 103: Library Files</title></head>
<body>

<!-- This commented out text is for the brittle SRFI tools -->
<!--
<H1>Title</H1>

Library Files

<H1>Author</H1>

Derick Eddington

<H1>Status</H1>

This SRFI is currently in ``draft'' status.
-->

<!-- This is the real, valid XHTML text -->
<h1>Title</h1>

<p>Library Files</p>

<h1>Author</h1>

<p>Derick Eddington</p>

<!-- ======================================================================= -->

<h1>Status</h1>

<p>
This SRFI is currently in ``draft'' status.  To see an explanation of
each status that a SRFI can hold, see <a
href="http://srfi.schemers.org/srfi-process.html">here</a>.

To provide input on this SRFI, please
<a href="mailto:srfi minus 103 at srfi dot schemers dot org">mail to
<code>&lt;srfi minus 103 at srfi dot schemers dot org&gt;</code></a>.  See
<a href="../srfi-list-subscribe.html">instructions here</a> to
subscribe to the list.  You can access previous messages via
<a href="mail-archive/maillist.html">the archive of the mailing list</a>.
</p>

<ul>
  <li>
    Received: <a href="http://srfi.schemers.org/cgi-bin/viewcvs.cgi/*checkout*/srfi/srfi-103/srfi-103.html?rev=1.1">2009/09/22</a></li>

  <li>Draft: 2009/09/22-2009/11/22</li>
  <li>Revised: 2009/10/16</li>
  <li>Revised: 2009/12/11</li>
  <li>Draft extended: 2009/12/11-2010/1/11</li>
</ul>

<!-- ======================================================================= -->

<h1>Table of contents</h1>

<ul>
<li><a href="#abstract">Abstract</a></li>
<li><a href="#rationale">Rationale</a></li>
<li><a href="#design">Design</a></li>
<li><a href="#specification">Specification</a>
<ul>
  <li><a href="#library-files">Library Files</a></li>
  <li><a href="#search-paths">Search Paths</a></li>
  <li><a href="#encoding">Encoding Characters</a></li>
  <li><a href="#extensions">File Name Extensions</a></li>
  <li><a href="#implicit-main">Implicit File Name</a></li>
  <li><a href="#ordering">Ordering</a></li>
  <li><a href="#r6rs-files">Portable R6RS Library Files</a></li>
</ul></li>
<li><a href="#companion-srfi">Companion SRFI</a></li>
<li><a href="#issues">Issues</a></li>
<li><a href="#acknowledgements">Acknowledgments</a></li>
<li><a href="#references">References</a></li>
<li><a href="#copyright">Copyright</a></li>
</ul>

<!-- ======================================================================= -->

<h1><a name="abstract">Abstract</a></h1>

<p>This SRFI defines a standard for naming and finding files containing
libraries, where a library name is a list of symbols.  It also defines a
standard file format and file name extension for portable R6RS libraries.  It
also supports dialects other than R6RS.</p>

<!-- ======================================================================= -->

<h1><a name="rationale">Rationale</a></h1>

<p>For libraries to be portably organized, distributed, installed, and available
for importing, using contemporary file systems, a standard is needed for naming
and finding the files containing libraries.  The
<a href="http://www.r6rs.org/">R6RS</a> does not specify how libraries are to be
made available for importing, and this SRFI addresses that by providing a
standard for R6RS library files.  Other dialects with list-of-symbols library
names may need a standard for library files, and this SRFI addresses that by
supporting such dialects.</p>

<!-- ======================================================================= -->

<h1><a name="design">Design</a></h1>

<p>This SRFI provides a method of finding library files based on libraries'
names by using each symbol component as a file path component.  The compound
nature of list-of-symbols library names allows for hierarchical grouping of
libraries under shared name prefixes, which is useful for avoiding name
conflicts with others' libraries and for organizing related libraries.  Such
library names are similar to file system paths because a path is a sequence of
strings naming an entity in a hierarchy of directories.  This similarity is
exploited to hierarchically organize library files in the way which corresponds
to hierarchical library names.</p>

<p>This SRFI only supports files which each contain only one library, for the
following reasons.  It is possible to one-to-one map a library file path to a
library name and so know what library a file contains from only its path and
without having to look in it, which allows knowing what libraries are present
and where from only a file name listing.  Also, to find a library, only file
names need to be searched for, as opposed to also searching through the contents
of files which each contain multiple libraries.</p>

<p>This SRFI provides configurable search paths and initializes them from a
standard environment variable.  In addition to allowing library files' locations
to be configurable, this allows configuring multiple Scheme systems to use the
same search paths and thus use the same directories and files containing
libraries.  This is desirable both for avoiding duplicating directories and
files and for being able to add or remove library files by simply putting them
into or deleting them from the search paths which all the systems are already
configured to use and so no further configuration or clean-up is required.</p>

<p>In library file paths, this SRFI encodes two characters which are used
specially, and it encodes the characters which Unixes and Windows disallow, and
it does not encode any other characters.  Unixes and Windows are chosen as the
platforms to cater to because they are the prevalent contemporary platforms.
Implementations of this SRFI are required to encode the same characters so that
files may be exchanged between Unixes and Windows without renaming.</p>

<p>This SRFI provides configurable file name extensions and initializes them
from a standard environment variable.  This supports multiple Scheme dialects,
supports Scheme-system-specific libraries, and supports users who desire to use
arbitrary extensions.  Dialects other than R6RS can use this SRFI by defining
their own file name extension.  System-specific libraries can be accomplished by
including a system-specific extension in the extensions.  Users can configure
the extensions by defining the environment variable.</p>

<p>This SRFI provides implicit file names which allow the last directory
containing a library's file to correspond to the last symbol of the library's
name (this is considered implicit because the last path component is not derived
from the library name).  This is useful for organizing all the files of
libraries with a shared name prefix under the same directory named after the
shared name prefix.  Users are free to use or not use implicit file names.</p>

<p>So that there is consistency between different Scheme systems about which
library file is used to satisfy a library reference, this SRFI specifies an
ordering of files matching a library reference, and this SRFI requires the
first-ordered match be used.</p>

<p>To provide a standard for portable R6RS library files, this SRFI specifies a
file format and a file name extension for R6RS library files, and this SRFI
requires R6RS systems to implement this standard.</p>

<!-- ======================================================================= -->

<h1><a name="specification">Specification</a></h1>

<h3><a name="library-files">Library Files</a></h3>

<p>A <i>library file</i> is a file which contains a library and which has a path
representing the name of the contained library.  Files conforming to this SRFI
must have only one library per file.  Except for <a href="#r6rs-files">portable
R6RS library files</a>, the format of library files' content is not
specified.</p>

<p>A <i>library file path</i> consists of, in order: possibly a search path
prefix, a sequence of path components corresponding to the sequence of symbols
in the contained library's name, possibly an implicitly added last path
component named <code>"main"</code>, and a file name extension.  Path components
are separated by a platform-dependent character.  The <code>#\.</code> character
is used in the last path component to separate the extension.  A <i>relative
library file path</i> is a library file path without a search path prefix.  An
<i>absolute library file path</i> is a library file path with a search path
prefix.</p>

<h3><a name="search-paths">Search Paths</a></h3>

<p><i>Search paths</i> is a sequence of paths which name directories.  When
finding library files, each search path is joined to each relative library file
path to make the set of possible locations.</p>

<p>The operating system environment variable <code>SCHEME_LIB_PATH</code>, if it
is defined, is used to initialize the search paths.  Its value is a string
containing a sequence of paths separated by a platform-dependent character.
Scheme systems may initialize the search paths to include additional paths
before or after those from the environment variable (such as paths given on the
command line which are before, or system default paths which are after).</p>

<p>The sequential ordering of the search paths provides precedence which allows
overlaying library files.  Multiple searched directories can contain different
files for the same libraries, and the files in directories with greatest
precedence are used instead of those in directories with lesser precedence.
This can be exploited to extend or override the available library files, without
modifying existing file system entities.</p>

<h3><a name="encoding">Encoding Characters</a></h3>

<p>Encoding characters in components of relative library file paths is necessary
to avoid conflicts with the characters this SRFI uses specially, and it is also
done to support the use of characters Unixes and Windows do not allow in paths.
The special characters of this SRFI are: <code>#\%</code> and the path
separator.  In addition to the two special characters, <code>#\x0</code>
to <code>#\x1F</code> (inclusive), <code>#\&lt;</code>, <code>#\&gt;</code>,
<code>#\:</code>, <code>#\"</code>, <code>#\/</code>, <code>#\\</code>,
<code>#\|</code>, <code>#\?</code>, and <code>#\*</code> are encoded, because
Windows disallows them and Unixes disallow <code>#\x0</code>.  All of these
characters must be encoded, and all other characters must not be encoded, when
transforming library name symbols to library file paths.</p>

<p>Characters are encoded using their UTF-8 encoding such that each UTF-8 byte
is represented as two hexadecimal digits, with alphabetic digits in upper case,
preceded by the <code>#\%</code> character.  E.g., a library named
<code>(a%b c/d e:f g*h)</code> may be in a file with path
<code>"/search/path/a%25b/c%2Fd/e%3Af/g%2Ah.ext"</code>.</p>

<h3><a name="extensions">File Name Extensions</a></h3>

<p><i>File name extensions</i> is a sequence of strings.  The strings must not
include the <code>#\.</code> character, and all other characters are allowed
(encoding is not done by this SRFI).  When finding library files, each extension
is joined to each incomplete library file path to make the set of possible
locations.  Except for <a href="#r6rs-files">portable R6RS library files</a>,
the extensions are not specified.</p>

<p>The operating system environment variable <code>SCHEME_LIB_EXT</code>, if it
is defined, is used to initialize the file name extensions.  Its value is a
string containing a sequence of extensions separated by a platform-dependent
character.  Scheme systems may initialize the extensions to include additional
extensions before or after those from the environment variable (such as
system-specific extensions).</p>

<p>Excluding the <code>#\.</code> character avoids conflict with library names
whose last symbol contains this character.  E.g., if this character was not
excluded, the extensions could be <code>"acme.ext"</code> and
<code>"ext"</code>, and it would be ambiguous if the file with path
<code>"/search/path/foo.acme.ext"</code> is for a library named
<code>(foo)</code> or for a library named <code>(foo.acme)</code>.</p>

<p>The sequential ordering of the extensions provides precedence, within the
same directory, which causes library files whose extensions have greatest
precedence to be used instead of files in the same directory for same-named
libraries whose extensions have lesser precedence.  This can be exploited to
have Scheme-system-specific libraries such that libraries specific to a system
are used instead of possibly-present generic libraries, and libraries specific
to other systems are ignored, and the files for all these libraries can coexist
in the same directory.  E.g., a library named <code>(foo)</code> may have
different implementations in files with paths
<code>"/search/path/foo.ext"</code>, <code>"/search/path/foo.acme-ext"</code>,
and <code>"/search/path/foo.ajax-ext"</code>, and the Acme Scheme system will
use the file with extension <code>"acme-ext"</code>, the Ajax Scheme system will
use the file with extension <code>"ajax-ext"</code>, and all other systems will
use the file with extension <code>"ext"</code>.</p>

<h3><a name="implicit-main">Implicit File Name</a></h3>

<p>An <i>implicit file name</i> is a library file path with a last path
component named <code>"main"</code>.  There are two possible directories under a
search path where a file for a library may be, because of implicit file
names.</p>

<p>Implicit file names must avoid conflict with non-implicit file names.  This
is accomplished by prepending the <code>#\_</code> character to the last
component of paths of non-implicit file names if the name of the last component
would otherwise have been zero or more <code>#\_</code> characters followed
by <code>"main"</code>.  E.g., a library named
<code>(foo)</code> may be in a file with path
<code>"/search/path/foo/main.ext"</code> or
<code>"/search/path/foo.ext"</code>, and a library named
<code>(foo main)</code> may be in a file with path
<code>"/search/path/foo/main/main.ext"</code> or
<code>"/search/path/foo/_main.ext"</code>, and a library named
<code>(foo _main)</code> may be in a file with path
<code>"/search/path/foo/_main/main.ext"</code> or
<code>"/search/path/foo/__main.ext"</code>.  This way, conflict is avoided
because the files for the three libraries can be named
<code>"/search/path/foo/main.ext"</code>,
<code>"/search/path/foo/_main.ext"</code>, and
<code>"/search/path/foo/__main.ext"</code>.
Note that a library named <code>(main)</code> may be in a file with path
<code>"/search/path/main/main.ext"</code> or
<code>"/search/path/_main.ext"</code>, and a library named
<code>(_main)</code> may be in a file with path
<code>"/search/path/_main/main.ext"</code> or
<code>"/search/path/__main.ext"</code>.  Technically, prepending the extra
<code>#\_</code> character for non-implicit file names of such single-symbol
library names is unnecessary, but it is always done to avoid causing an
exceptional case.</p>

<h3><a name="ordering">Ordering</a></h3>

<p>A library reference may match multiple files which each contain an
implementation of the library.  This SRFI specifies an ordering for all the
possibilities of matching files.  Scheme systems must choose the first-ordered
match.</p>

<p>Multiple files matching a library reference is possible because of: multiple
search paths containing matches, implicit and non-implicit file name matches,
and matches with different file name extensions.  This SRFI uses a multi-level
ordering for these possibilities.  The first level is search paths, the second
level is implicit naming of files, and the third level is file name
extensions.</p>

<p>Matches in a search path which is ordered before another search path are
ordered before matches in the other search path.  Within the same search path,
implicit file name matches are ordered before non-implicit file name matches.
Within the same directory, a match with an extension which is ordered before the
extension of another match is ordered before the other match.</p>

<dl><dt>Example:</dt>
       <dd><dl><dt>Given this sequence of search paths:</dt>
                  <dd><code>spd</code></dd>
                  <dd><code>s/p/c</code></dd>
                  <dd><code>spb</code></dd>
                  <dd><code>/s/p/a</code></dd></dl></dd>
       <dd><dl><dt>Given this sequence of file name extensions:</dt>
                  <dd><code>acme-ext</code></dd>
                  <dd><code>ext</code></dd></dl></dd>
       <dd><dl><dt>Given this structure of directories and files:</dt>
                  <dd><dl><dt><code>/s/p/a/</code></dt>
                          <dd><dl><dt><code>foo/</code></dt>
                                  <dd><code>bar.acme-ext</code></dd>
                                  <dd><code>bar.other-ext</code></dd>
                                  <dd><code>bar.png</code></dd>
                                  <dd><code>bar.ext</code></dd>
                                  <dd><code>zab.ext</code></dd>
                                  <dd><dl><dt><code>bar/</code></dt>
                                          <dd><code>main.acme-ext</code></dd>
                                          <dd><code>main.ext</code></dd>
                                          <dd><code>blah.ext</code></dd>
                                      </dl></dd>
                              </dl></dd>
                          <dt><code>s/p/c/</code></dt>
                          <dd><dl><dt><code>foo/</code></dt>
                                  <dd><code>bar.ext</code></dd>
                                  <dd><dl><dt><code>bar/</code></dt>
                                          <dd><code>main.other-ext</code></dd>
                                      </dl></dd>
                              </dl></dd>
                          <dt><code>spb/</code></dt>
                          <dd><dl><dt><code>foo/</code></dt>
                                  <dd><code>zab.ext</code></dd>
                                  <dd><dl><dt><code>bar/</code></dt>
                                          <dd><code>main.ext</code></dd>
                                      </dl></dd>
                              </dl></dd>
                          <dt><code>spd/</code></dt>
                          <dd><dl><dt><code>foo/</code></dt>
                                  <dd><code>it.ext</code></dd>
                                  <dd><dl><dt><code>bar/</code></dt>
                                          <dd><code>thing.ext</code></dd>
                                      </dl></dd>
                              </dl></dd>
                      </dl></dd></dl></dd>
       <dd><dl><dt>The ordering for the files matching the library reference
	           <code>(foo bar)</code> is:</dt>
                  <dd><code>s/p/c/foo/bar.ext</code></dd>
                  <dd><code>spb/foo/bar/main.ext</code></dd>
                  <dd><code>/s/p/a/foo/bar/main.acme-ext</code></dd>
                  <dd><code>/s/p/a/foo/bar/main.ext</code></dd>
                  <dd><code>/s/p/a/foo/bar.acme-ext</code></dd>
                  <dd><code>/s/p/a/foo/bar.ext</code></dd>
               <dt>The file required to be used is:</dt>
                  <dd><code>s/p/c/foo/bar.ext</code></dd>
           </dl></dd>
</dl>

<h3><a name="r6rs-files">Portable R6RS Library Files</a></h3>

<p>R6RS systems which implement this SRFI must conform to the following
additional requirements.  Files with extension <code>"r6rs-lib"</code>, which
contain a library as an
<a href="http://www.r6rs.org/final/html/r6rs/r6rs-Z-H-10.html#node_sec_7.1">
R6RS library form</a> as the first syntactic datum which the R6RS
<code>read</code> procedure would return, must be supported.  The file name
extension <code>"r6rs-lib"</code> must be implicitly included in the extensions
when the <code>SCHEME_LIB_EXT</code> environment variable is not defined.</p>

<p>R6RS systems which desire to support system-specific libraries are
encouraged, not required, to implicitly include a file name extension of the
form <code>"acme-r6rs-lib"</code>, substituting the system's name for
<code>"acme"</code>, and to order such extension before
<code>"r6rs-lib"</code>.</p>

<!-- ======================================================================= -->

<h1><a name="companion-srfi">Companion SRFI</a></h1>

<p>
<a href="http://srfi.schemers.org/srfi-104/srfi-104.html">SRFI 104: Library
Files Utilities</a> is a companion to this SRFI.  It is the reference
implementation of this SRFI, and it is intended to be useful as a means for
Scheme systems to implement this SRFI, and it is a library intended to be useful
to users working with library files.  It is separate from this SRFI so that this
SRFI does not require providing a library API.  It is intended to be useful
whether or not systems use it to implement this SRFI.
</p>

<!-- ======================================================================= -->

<h1><a name="issues">Issues</a></h1>

<p>
(Section which points out things to be resolved.  This will not appear in the
final SRFI.)
</p>

<ul>
  <li><p>TODO: Anything?</p></li>
</ul>

<!-- ======================================================================= -->

<h1><a name="acknowledgements">Acknowledgments</a></h1>

<p>I thank Ikarus for the idea of Scheme-system-specific file name extensions.
I thank PLT for the idea of implicit file names.  I thank all those who
participated during the draft period of this SRFI and in earlier discussions in
various other forums.  I thank David Van Horn for editing this SRFI and for
suggesting it be separated from its companion SRFI.</p>

<h1><a name="references">References</a></h1>

<dl>
  <dt>Revised<sup>6</sup> Report on the Algorithmic Language Scheme</dt>
  <dd>Michael Sperber, <i>et al.</i> (Editors)<br/>
    <a href="http://www.r6rs.org/">http://www.r6rs.org/</a></dd>

  <dt>SRFI 104: Library Files Utilities</dt>
  <dd>Derick Eddington<br/>
      <a href="http://srfi.schemers.org/srfi-104/srfi-104.html">
      http://srfi.schemers.org/srfi-104/srfi-104.html</a></dd>
</dl>

<!-- ======================================================================= -->

<h1><a name="copyright">Copyright</a></h1>

<p>
Copyright (C) Derick Eddington (2009). All Rights Reserved.
</p>
<p>
Permission is hereby granted, free of charge, to any person obtaining a
copy of this software and associated documentation files (the "Software"),
to deal in the Software without restriction, including without limitation
the rights to use, copy, modify, merge, publish, distribute, sublicense,
and/or sell copies of the Software, and to permit persons to whom the
Software is furnished to do so, subject to the following conditions:
</p><p>
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
</p><p>
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
DEALINGS IN THE SOFTWARE.
</p>
    <hr/>
    <address>Editor: <a href="mailto:srfi-editors at srfi dot schemers dot org">
             David Van Horn</a></address>
  </body>
</html>
